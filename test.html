<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-NJXGk7R+8gWGBdutmr+/d6XDokLwQhF1U3VA7FhvBDlOq7cNdI69z7NQdnXxcF7k" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:600,700|Roboto:300,400" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="style.css" />

        <link rel="icon" href="{{site.baseurl}}/favicon.png" sizes="16x16" type="image/png">
        
        <title>{% if page.title %}{{ page.title }} – {% endif %}{{ site.name }} – {{ site.description }}</title>
    </head>
    <body>
        <nav class="navbar navbar-expand-md navbar-dark bg-dark">
            <div class='container'>
                <nav class="navbar navbar-light bg-light">
                    <a class="navbar-brand mx-auto" href="{{site.url}}">2RS2NS</a>
                </nav>
            </div>
        </nav>

        <div class='hero-image'>
            <img class='img-fluid' src='/drive/projects/2rs2ns/images/camera.jpg'>
        </div>

        <div class='main'>
            <div class='container'>
                <div class='row'>
                    <div class='col-12'>
                        <div class='content'>
                            <article class="post">
                                <h1>Setting custom Arlo modes with NodeRed</h1>
                  
                                <div class="entry">
                                    I purchased my Arlo security cameras knowing that I wanted to integrate them into my HomeAssistant/NodeRed installation. After getting them set up I installed the Arlo Alarm
                                    & Arlo Camera components, I was disappointed with the integration. The statuses would be unreliable at best and trying to run any kind of automations against them was a nightmare.


                                    With occupancy sensors already configured in my HomeAssistant [see Phil Hawthorn's post here](https://philhawthorne.com/making-home-assistants-presence-detection-not-so-binary/), I started looking 
                                    to external services to automate my arming & disarming of arlo. I already had some [IFTTT](https://ifttt.com) automations so I thought I would check it out first and was disappointed again to see
                                    that setting custom modes was not supported.

                                    I figured I wasn't the only one who was frustrated with Arlo, I started looking into the Arlo API itself. While not documented by Arlo, Roberto Gallea [had a great post](https://www.robertogallea.com/blog/netgear-arlo-api) documenting all the endpoints
                                    for me to use via NodeRed. 

                                    A great way to explore this API is to use [Postman](https://www.getpostman.com/).

                                    ## 1. Authenticate against Arlo API
                                    You'll be able to authenticate to the Arlo website by making the following call:
                                    ```
                                    curl -H "Content-Type: application/json;charset=UTF-8" -d '{"email":"YOUR_EMAIL","password":"YOUR_PASSWORD"}' -X POST "https://arlo.netgear.com/hmsweb/login/v2"
                                    ```
                                    Which should return a document similar to 

                                    ```json
                                    {
                                        "data": {
                                            "userId": "YOUR_USER_ID",
                                            "email": "YOUR_EMAIL",
                                            "token": "YOUR_TOKEN",
                                            "paymentId": "YOUR_PAYMENT_ID",
                                            "authenticated": 1504597425,
                                            "accountStatus": "registered",
                                            "serialNumber": "YOUR_SERIAL_NUMBER",
                                            "countryCode": "IT",
                                            "tocUpdate": false,
                                            "policyUpdate": false,
                                            "validEmail": true,
                                            "arlo": true,
                                            "dateCreated": 1477059159622
                                        },
                                        "success": true
                                    }
                                    ```

                                    What we need in this response is the `token`

                                    ## 2. Retrieve DeviceId & xCloudId
                                    After retrieving your token, you'll need to the the deviceId of your base station (or whatever other device) you'll want to change the mode on. You can do this by making the following request:
                                    ```
                                    curl -H "Authorization: YOUR_TOKEN" -X GET "https://arlo.netgear.com/hmsweb/users/devices"
                                    ```

                                    This request will return a response similar to the following

                                    ```json
                                    {
                                        "data": [
                                            {
                                                "userId": "AB12-2345-6787878",
                                                "deviceId": "0123456789ABC",
                                                "parentId": "CBA9876543210",
                                                "uniqueId": "AB12-2345-6787878_48B5647F83E96",
                                                "deviceType": "camera",
                                                "deviceName": "Your camera name",
                                                "lastModified": 1504596539327,
                                                "xCloudId": "35CK-1005-210-4644171",
                                                "lastImageUploaded": "true",
                                                "userRole": "OWNER",
                                                "displayOrder": 1,
                                                "presignedLastImageUrl": "https://arlolastimage-z1.s3.amazonaws.com/......./....",
                                                "presignedSnapshotUrl": "https://arlos3-prod-z1.s3.amazonaws.com/.../.....",
                                                "presignedFullFrameSnapshotUrl": "https://arlos3-prod-z1.s3.amazonaws.com/..../.....",
                                                "mediaObjectCount": 0,
                                                "state": "provisioned",
                                                "modelId": "VMC3030",
                                                "interfaceVersion": "i000",
                                                "interfaceSchemaVer": "2",
                                                "owner": {
                                                    "firstName": "OwnerFirstName",
                                                    "lastName": "OwnerLastName",
                                                    "ownerId": "3ACD-458-4578956"
                                                },
                                                "properties": {
                                                    "modelId": "VMC3030",
                                                    "olsonTimeZone": "Europe/Amsterdam",
                                                    "hwVersion": "H7"
                                                }
                                            },        
                                            {
                                                "userId": "CD12-2345-6787878",
                                                "deviceId": "0123456789CDE",
                                                "uniqueId": "CD12-2345-6787878_48B5647F83E96",
                                                "deviceType": "basestation",
                                                "deviceName": "YourBaseStationName",
                                                "lastModified": 1504596539327,
                                                "xCloudId": "35CK-1005-210-4644171",
                                                "userRole": "OWNER",
                                                "displayOrder": 2,
                                                "mediaObjectCount": 0,
                                                "state": "provisioned",
                                                "modelId": "VMB3010",
                                                "interfaceVersion": "i001",
                                                "interfaceSchemaVer": "2",
                                                "owner": {
                                                    "firstName": "OwnerFirstName",
                                                    "lastName": "OwnerLastName",
                                                "properties": {
                                                    "modelId": "VMB3010",
                                                    "olsonTimeZone": "Europe/Amsterdam",
                                                    "hwVersion": "VMB3010r2"
                                                }
                                            }
                                        ],
                                        "success": true
                                    }
                                    ```    

                                    From this response you'll need `deviceId` and `xCloudId`


                                    ## 3. Find the "modeId" of the mode you wish to set.
                                    You can find the modeId of the mode you wish to set by going to Arlo's website and logging in. Browse to your modes page and edit one of your custom modes. Look in the url and you'll see your modeId:
                                    <img src="https://i.imgur.com/b8ubLBN.jpg" class='img-fluid'>

                                    ## 4. Make request to change device mode.

                                    Using all the information we've gathered, we can now make a `POST` to Arlo's api, to change our mode with the following request:
                                    ```
                                    curl -H "Content-Type: application/json;charset=UTF-8" -H "Authorization: YOUR_TOKEN" -H "xcloudid: DEVICE_XCLOUDID" -d "JSON_OBJECT" -X POST "https://arlo.netgear.com/hmsweb/users/devices/notify/DEVICE_ID"
                                    ```

                                    ## 5. Implement in NodeRed
                                    You can use the `function` node and the `http request` node to make this call.
                                    First you will need to drop a function node in your flow and set the following payload variables replacing text in brackets `$$` with values for your request:


                                    Variable | Value
                                    --- | ---
                                    $FROM$ | A random string. I used one to identify my home assistant instance
                                    $DEVICEID$ | The device id you wish to change modes on
                                    $TRANSACTIONID$ | A random string
                                    $MODEID$ | The modeID you wish to set your device to received in step 3. "mode0" for the default "disarmed" and "mode1" for the default "armed"
                                    $TOKEN$ | The token you received in step 1.
                                    $XCLOUDID$ | The xCloudId for your device recieved in step 2.



                                    ```
                                    msg.payload = '{"from":"$FROM$","to":"$DEVICEID$","action":"set","resource":"modes","transId":"$TRANSACTIONID$","publishResponse":true,"properties": {"active":"$MODEID$"}}';
                                    msg.headers = {};
                                    msg.headers['Content-Type'] = 'application/json';
                                    msg.headers['Authorization'] = '$TOKEN$';
                                    msg.headers['xcloudId'] = '$XCLOUDID$';
                                    return msg;
                                    ```

                                    Next you will need to drop an `http request` node into your flow and enter the the url to the arlo service, filling in `$DEVICEID$` with your deviceid:
                                    ```
                                    https://arlo.netgear.com/hmsweb/users/devices/notify/$DEVICEID$/
                                    ```

                                    <img src="https://i.imgur.com/S6Iv03b.jpg" class='img-fluid'>

                                    ## That's it.

                                    When this flow run, your Arlo device should change modes.
                                </div>

                                <div class="date">
                                    {{ page.date | date: "%B %e, %Y" }}
                                </div>
                            </article>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        

        <footer>
        </footer>
        {% include analytics.html %}
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    </body>
</html>